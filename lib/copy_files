# create dictionary
import shutil
import pandas as pd
import os
import numpy as np
import pandas as pd


def rename_and_copy(new_ids, input_dir, output_dir):

    new_dict = {}
    feature_list = ['patient', 'DWI', 'FLAIR', 'ADC', 'TTP', 'PWI', 'ADC_BS', 'ADC_Cor', 'DWI_BS',
                                          'DWI_Cor', 'DWI_Cor', 'FLAIR', 'GBP', 'GRE', 'PBP', 'RAPID_All', 'RAPID_CBF',
                                          'RAPID_CBF_C', 'RAPID_CBV_C', 'RAPID_DWI', 'RAPID_MTT', 'RAPID_MTT_C',
                                          'RAPID_PW', 'RAPID_PWI', 'RAPID_TMAX', 'RAPID_TMAX_C', 'T1', 'T1_Cor',
                                          'T1_Post', 'T1_Pre', 'T2', 'TTP']
    patient_series_info = pd.DataFrame(columns=feature_list)

    new_ids = np.array(new_ids)
    for row in new_ids:
        new_dict[row[0]] = row[1]

    for patient in os.listdir(input_dir):
        print(patient)
        # make the directory in clean directory if it doesnt work.
        pt_dir = os.path.join(input_dir, patient)
        nii_output = os.path.join(output_dir, patient)
        if not os.path.isdir(nii_output):
            os.makedirs(nii_output)
        patient_row = pd.DataFrame(0, columns=feature_list)
        patient_row.iloc[0, patient_row.columns.get_loc('patient')] = patient
        for nifti_file in os.listdir(pt_dir):
            # if file is the first version AND nifti
            if nifti_file.endswith('_i00001.nii.gz'):
                nifti_name = nifti_file[:-14]
                if nifti_name in new_dict.keys():
                    print(nifti_name)
                    patient_row.iloc[0, patient_row.columns.get_loc(nifti_name)] = 1
                    shutil.copy(os.path.join(pt_dir, nifti_file), os.path.join(nii_output,
                                                                               new_dict[nifti_name]+'.nii.gz'))
            elif nifti_file.endswith('.nii.gz'):
                nifti_name = nifti_file[:-7]
                if nifti_name in new_dict.keys():
                    print(nifti_name)
                    shutil.copy(os.path.join(pt_dir, nifti_file), os.path.join(nii_output,
                                                                               new_dict[nifti_name]+'.nii.gz'))
        patient_series_info.append(patient_row)

    patient_series_info.to_csv('/home/harryzhang/Desktop/patient_series_info.csv', index=False)


# check unique cases
def check_unique_cases(clean_dir):
    list_of_series = []
    for p in os.listdir(clean_dir):
        pt_dir = os.path.join(clean_dir, p)
        for nifti_file in os.listdir(pt_dir):
            if nifti_file.endswith('_i00001.nii.gz'):
                if nifti_file[:-14] not in list_of_series:
                    list_of_series.append(nifti_file[:-14])
            elif nifti_file.endswith('.nii.gz'):
                if nifti_file[:-7] not in list_of_series:
                    list_of_series.append(nifti_file[:-7])
    return list_of_series


if __name__ == '__main__':
    ids = pd.read_csv('/home/harryzhang/PACS_QUERY/image_dict.csv', header=None)
    nifti_input_dir = '/media/harryzhang/VolumeWD/NIFTI_Images'
    nifti_output_dir = '/media/harryzhang/VolumeWD/NIFTI_Renamed'

    rename_and_copy(ids, nifti_input_dir, nifti_output_dir)
    check_unique_cases(nifti_output_dir)


